<?php
$page_title = 'Checkout';
$page_description = 'Complete your order at Angel Marketplace. Secure checkout process with multiple payment options.';

require_once 'includes/functions.php';

// Check if cart is empty
$cart = getCart();
if (empty($cart)) {
    header('Location: /ampmkp/cart.php');
    exit;
}

// Get cart details
$cartItems = [];
$subtotal = 0;

foreach ($cart as $item) {
    $product = getProductById($item['product_id']);
    if ($product) {
        $itemTotal = $product['price'] * $item['quantity'];
        $cartItems[] = [
            'product' => $product,
            'quantity' => $item['quantity'],
            'item_total' => $itemTotal
        ];
        $subtotal += $itemTotal;
    }
}

// Calculate totals
$settings = getSettings();
$shippingCost = $subtotal >= $settings['shipping']['free_shipping_threshold'] ? 0 : $settings['shipping']['standard_shipping_cost'];
$total = $subtotal + $shippingCost;

$success = false;
$error = '';

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Get form data
    $customerData = [
        'email' => sanitizeInput($_POST['email'] ?? ''),
        'first_name' => sanitizeInput($_POST['first_name'] ?? ''),
        'last_name' => sanitizeInput($_POST['last_name'] ?? ''),
        'phone' => sanitizeInput($_POST['phone'] ?? ''),
        'address' => sanitizeInput($_POST['address'] ?? ''),
        'city' => sanitizeInput($_POST['city'] ?? ''),
        'postal_code' => sanitizeInput($_POST['postal_code'] ?? ''),
        'country' => sanitizeInput($_POST['country'] ?? ''),
        'payment_method' => sanitizeInput($_POST['payment_method'] ?? ''),
        'special_instructions' => sanitizeInput($_POST['special_instructions'] ?? '')
    ];
    
    // Validation
    $required_fields = ['email', 'first_name', 'last_name', 'address', 'city', 'postal_code', 'country', 'payment_method'];
    $missing_fields = [];
    
    foreach ($required_fields as $field) {
        if (empty($customerData[$field])) {
            $missing_fields[] = ucwords(str_replace('_', ' ', $field));
        }
    }
    
    if (!empty($missing_fields)) {
        $error = 'Please fill in all required fields: ' . implode(', ', $missing_fields);
    } elseif (!validateEmail($customerData['email'])) {
        $error = 'Please enter a valid email address.';
    } else {
        // Create order
        $orderId = 'AMP' . date('Y') . sprintf('%06d', time() % 1000000);
        
        $orderData = [
            'id' => $orderId,
            'customer' => $customerData,
            'items' => $cartItems,
            'subtotal' => $subtotal,
            'shipping_cost' => $shippingCost,
            'total' => $total,
            'status' => 'pending',
            'payment_status' => 'pending',
            'created_at' => date('Y-m-d H:i:s'),
            'currency' => $settings['currency_code']
        ];
        
        // Save order
        $orders = readJsonFile('orders.json');
        $orders[] = $orderData;
        
        if (writeJsonFile('orders.json', $orders)) {
            // Clear cart
            clearCart();
            
            // Redirect to success page
            header('Location: /ampmkp/order-success.php?order=' . $orderId);
            exit;
        } else {
            $error = 'Sorry, there was an error processing your order. Please try again.';
        }
    }
}

include 'includes/header.php';
?>

<!-- Breadcrumb -->
<div class="bg-gray-50 py-4">
    <div class="container mx-auto px-4">
        <nav class="text-sm">
            <a href="/ampmkp/" class="text-blue-600 hover:text-blue-700">Home</a>
            <span class="mx-2 text-gray-500">/</span>
            <a href="/ampmkp/cart.php" class="text-blue-600 hover:text-blue-700">Cart</a>
            <span class="mx-2 text-gray-500">/</span>
            <span class="text-gray-700">Checkout</span>
        </nav>
    </div>
</div>

<!-- Checkout -->
<section class="bg-white py-12">
    <div class="container mx-auto px-4">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-900 mb-8">Checkout</h1>
            
            <?php if ($error): ?>
                <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex">
                        <svg class="w-5 h-5 text-red-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Error</h3>
                            <p class="mt-1 text-sm text-red-700"><?php echo htmlspecialchars($error); ?></p>
                        </div>
                    </div>
                </div>
            <?php endif; ?>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Checkout Form -->
                <div class="lg:col-span-2">
                    <form method="POST" class="space-y-8">
                        <!-- Customer Information -->
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h2 class="text-xl font-semibold text-gray-900 mb-6">Customer Information</h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="first_name" class="block text-sm font-medium text-gray-700 mb-2">
                                        First Name <span class="text-red-500">*</span>
                                    </label>
                                    <input 
                                        type="text" 
                                        id="first_name" 
                                        name="first_name" 
                                        value="<?php echo htmlspecialchars($customerData['first_name'] ?? ''); ?>"
                                        required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    >
                                </div>
                                
                                <div>
                                    <label for="last_name" class="block text-sm font-medium text-gray-700 mb-2">
                                        Last Name <span class="text-red-500">*</span>
                                    </label>
                                    <input 
                                        type="text" 
                                        id="last_name" 
                                        name="last_name" 
                                        value="<?php echo htmlspecialchars($customerData['last_name'] ?? ''); ?>"
                                        required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    >
                                </div>
                                
                                <div>
                                    <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
                                        Email Address <span class="text-red-500">*</span>
                                    </label>
                                    <input 
                                        type="email" 
                                        id="email" 
                                        name="email" 
                                        value="<?php echo htmlspecialchars($customerData['email'] ?? ''); ?>"
                                        required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    >
                                </div>
                                
                                <div>
                                    <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                                        Phone Number
                                    </label>
                                    <input 
                                        type="tel" 
                                        id="phone" 
                                        name="phone" 
                                        value="<?php echo htmlspecialchars($customerData['phone'] ?? ''); ?>"
                                        class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    >
                                </div>
                            </div>
                        </div>
                        
                        <!-- Shipping Address -->
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h2 class="text-xl font-semibold text-gray-900 mb-6">Shipping Address</h2>
                            
                            <div class="space-y-6">
                                <div>
                                    <label for="address" class="block text-sm font-medium text-gray-700 mb-2">
                                        Street Address <span class="text-red-500">*</span>
                                    </label>
                                    <input 
                                        type="text" 
                                        id="address" 
                                        name="address" 
                                        value="<?php echo htmlspecialchars($customerData['address'] ?? ''); ?>"
                                        required
                                        class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="123 Main Street, Apt 4B"
                                    >
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label for="city" class="block text-sm font-medium text-gray-700 mb-2">
                                            City <span class="text-red-500">*</span>
                                        </label>
                                        <input 
                                            type="text" 
                                            id="city" 
                                            name="city" 
                                            value="<?php echo htmlspecialchars($customerData['city'] ?? ''); ?>"
                                            required
                                            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        >
                                    </div>
                                    
                                    <div>
                                        <label for="postal_code" class="block text-sm font-medium text-gray-700 mb-2">
                                            Postal Code <span class="text-red-500">*</span>
                                        </label>
                                        <input 
                                            type="text" 
                                            id="postal_code" 
                                            name="postal_code" 
                                            value="<?php echo htmlspecialchars($customerData['postal_code'] ?? ''); ?>"
                                            required
                                            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        >
                                    </div>
                                    
                                    <div>
                                        <label for="country" class="block text-sm font-medium text-gray-700 mb-2">
                                            Country <span class="text-red-500">*</span>
                                        </label>
                                        <select 
                                            id="country" 
                                            name="country" 
                                            required
                                            class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        >
                                            <option value="">Select Country</option>
                                            <option value="UK" <?php echo ($customerData['country'] ?? '') === 'UK' ? 'selected' : ''; ?>>United Kingdom</option>
                                            <option value="US" <?php echo ($customerData['country'] ?? '') === 'US' ? 'selected' : ''; ?>>United States</option>
                                            <option value="CA" <?php echo ($customerData['country'] ?? '') === 'CA' ? 'selected' : ''; ?>>Canada</option>
                                            <option value="AU" <?php echo ($customerData['country'] ?? '') === 'AU' ? 'selected' : ''; ?>>Australia</option>
                                            <option value="DE" <?php echo ($customerData['country'] ?? '') === 'DE' ? 'selected' : ''; ?>>Germany</option>
                                            <option value="FR" <?php echo ($customerData['country'] ?? '') === 'FR' ? 'selected' : ''; ?>>France</option>
                                            <option value="NL" <?php echo ($customerData['country'] ?? '') === 'NL' ? 'selected' : ''; ?>>Netherlands</option>
                                            <option value="OTHER" <?php echo ($customerData['country'] ?? '') === 'OTHER' ? 'selected' : ''; ?>>Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Payment Method -->
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h2 class="text-xl font-semibold text-gray-900 mb-6">Payment Method</h2>
                            
                            <div class="space-y-4">
                                <label class="relative flex items-center p-4 bg-white border border-gray-200 rounded-lg cursor-pointer hover:border-blue-300">
                                    <input 
                                        type="radio" 
                                        name="payment_method" 
                                        value="card" 
                                        class="sr-only payment-radio"
                                        <?php echo ($customerData['payment_method'] ?? '') === 'card' ? 'checked' : ''; ?>
                                        onchange="showPaymentForm('card')"
                                    >
                                    <div class="payment-option w-full">
                                        <div class="flex items-center">
                                            <svg class="w-6 h-6 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                                            </svg>
                                            <div>
                                                <h3 class="font-semibold text-gray-900">Credit/Debit Card</h3>
                                                <p class="text-sm text-gray-600">Pay securely with your card</p>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                                
                                <label class="relative flex items-center p-4 bg-white border border-gray-200 rounded-lg cursor-pointer hover:border-blue-300">
                                    <input 
                                        type="radio" 
                                        name="payment_method" 
                                        value="paypal" 
                                        class="sr-only payment-radio"
                                        <?php echo ($customerData['payment_method'] ?? '') === 'paypal' ? 'checked' : ''; ?>
                                        onchange="showPaymentForm('paypal')"
                                    >
                                    <div class="payment-option w-full">
                                        <div class="flex items-center">
                                            <svg class="w-6 h-6 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                            </svg>
                                            <div>
                                                <h3 class="font-semibold text-gray-900">PayPal</h3>
                                                <p class="text-sm text-gray-600">Pay with your PayPal account</p>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                                
                                <label class="relative flex items-center p-4 bg-white border border-gray-200 rounded-lg cursor-pointer hover:border-blue-300">
                                    <input 
                                        type="radio" 
                                        name="payment_method" 
                                        value="bank_transfer" 
                                        class="sr-only payment-radio"
                                        <?php echo ($customerData['payment_method'] ?? '') === 'bank_transfer' ? 'checked' : ''; ?>
                                        onchange="showPaymentForm('bank_transfer')"
                                    >
                                    <div class="payment-option w-full">
                                        <div class="flex items-center">
                                            <svg class="w-6 h-6 text-blue-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-4m-5 0H3m2 0h4m0 0v-5a2 2 0 012-2h2a2 2 0 012 2v5"></path>
                                            </svg>
                                            <div>
                                                <h3 class="font-semibold text-gray-900">Bank Transfer</h3>
                                                <p class="text-sm text-gray-600">Direct bank transfer</p>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            </div>
                            
                            <!-- Payment Forms -->
                            <div class="mt-6">
                                <!-- Credit Card Form -->
                                <div id="card-form" class="payment-form hidden">
                                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Card Details</h3>
                                        <div class="grid grid-cols-1 gap-4">
                                            <div>
                                                <label for="card_number" class="block text-sm font-medium text-gray-700 mb-2">
                                                    Card Number <span class="text-red-500">*</span>
                                                </label>
                                                <input 
                                                    type="text" 
                                                    id="card_number" 
                                                    name="card_number" 
                                                    placeholder="1234 5678 9012 3456"
                                                    maxlength="19"
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                    oninput="formatCardNumber(this)"
                                                >
                                            </div>
                                            <div class="grid grid-cols-2 gap-4">
                                                <div>
                                                    <label for="expiry_date" class="block text-sm font-medium text-gray-700 mb-2">
                                                        Expiry Date <span class="text-red-500">*</span>
                                                    </label>
                                                    <input 
                                                        type="text" 
                                                        id="expiry_date" 
                                                        name="expiry_date" 
                                                        placeholder="MM/YY"
                                                        maxlength="5"
                                                        class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                        oninput="formatExpiryDate(this)"
                                                    >
                                                </div>
                                                <div>
                                                    <label for="cvv" class="block text-sm font-medium text-gray-700 mb-2">
                                                        CVV <span class="text-red-500">*</span>
                                                    </label>
                                                    <input 
                                                        type="text" 
                                                        id="cvv" 
                                                        name="cvv" 
                                                        placeholder="123"
                                                        maxlength="4"
                                                        class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                                    >
                                                </div>
                                            </div>
                                            <div>
                                                <label for="cardholder_name" class="block text-sm font-medium text-gray-700 mb-2">
                                                    Cardholder Name <span class="text-red-500">*</span>
                                                </label>
                                                <input 
                                                    type="text" 
                                                    id="cardholder_name" 
                                                    name="cardholder_name" 
                                                    placeholder="Name as it appears on card"
                                                    class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                >
                                            </div>
                                        </div>
                                        <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                                            <div class="flex items-center">
                                                <svg class="w-5 h-5 text-green-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                                </svg>
                                                <span class="text-sm text-gray-600">Your card details are encrypted and secure</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- PayPal Form -->
                                <div id="paypal-form" class="payment-form hidden">
                                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-4">PayPal Payment</h3>
                                        <div class="text-center py-8">
                                            <div class="text-blue-600 mb-4">
                                                <svg class="w-16 h-16 mx-auto" fill="currentColor" viewBox="0 0 24 24">
                                                    <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.023.143-.047.288-.077.437-.983 4.814-4.622 6.253-8.552 6.253H9.098a.905.905 0 0 0-.983.817l-.554 3.583-.021.125-.656 4.203a.641.641 0 0 1-.633.556c-.016.003-.016.003-.175.003z"/>
                                                    <path d="M13.781 2.601c-.24 1.58-.85 2.715-1.738 3.414-.542.423-1.213.656-1.998.656H6.98a.905.905 0 0 0-.988.817l-.614 3.96-.033.212a.641.641 0 0 1-.633.556H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c1.653 0 2.995.24 4.024.71.674.306 1.153.71 1.442 1.22.17.3.255.65.289 1.053.023.143.023.288.023.437-.057.905-.24 1.938-.455 3.145z"/>
                                                </svg>
                                            </div>
                                            <h4 class="text-lg font-semibold text-gray-900 mb-2">Pay with PayPal</h4>
                                            <p class="text-gray-600 mb-6">You'll be redirected to PayPal to complete your payment securely.</p>
                                            <div class="bg-blue-50 p-4 rounded-lg">
                                                <p class="text-sm text-blue-700">
                                                    <strong>Note:</strong> After clicking "Place Order", you'll be taken to PayPal where you can log in and complete your payment.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Bank Transfer Form -->
                                <div id="bank_transfer-form" class="payment-form hidden">
                                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Bank Transfer Details</h3>
                                        <div class="space-y-4">
                                            <div class="bg-gray-50 p-4 rounded-lg">
                                                <h4 class="font-semibold text-gray-900 mb-3">Transfer to:</h4>
                                                <div class="space-y-2 text-sm">
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Bank Name:</span>
                                                        <span class="font-medium">Angel Marketplace Bank</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Account Name:</span>
                                                        <span class="font-medium">Angel Marketplace Ltd</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Account Number:</span>
                                                        <span class="font-medium font-mono">12345678</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">Sort Code:</span>
                                                        <span class="font-medium font-mono">12-34-56</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">IBAN:</span>
                                                        <span class="font-medium font-mono">GB12 ABCD 1234 5678 9012 34</span>
                                                    </div>
                                                    <div class="flex justify-between">
                                                        <span class="text-gray-600">SWIFT/BIC:</span>
                                                        <span class="font-medium font-mono">ABCDGB2L</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                                                <div class="flex">
                                                    <svg class="w-5 h-5 text-yellow-400 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.664-.833-2.464 0L5.232 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                                    </svg>
                                                    <div>
                                                        <h4 class="text-sm font-medium text-yellow-800">Important:</h4>
                                                        <div class="mt-1 text-sm text-yellow-700">
                                                            <ul class="list-disc list-inside space-y-1">
                                                                <li>Please include your order number <strong><?php echo 'AMP' . date('Y') . sprintf('%06d', time() % 1000000); ?></strong> in the transfer reference</li>
                                                                <li>Your order will be processed after payment confirmation (1-3 business days)</li>
                                                                <li>Keep your transfer receipt for your records</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Special Instructions -->
                        <div class="bg-gray-50 p-6 rounded-lg">
                            <h2 class="text-xl font-semibold text-gray-900 mb-6">Special Instructions</h2>
                            <textarea 
                                name="special_instructions" 
                                rows="4" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Any special delivery instructions or notes for your order..."
                            ><?php echo htmlspecialchars($customerData['special_instructions'] ?? ''); ?></textarea>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="flex flex-col sm:flex-row gap-4">
                            <a href="/ampmkp/cart.php" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 px-8 py-3 rounded-md font-medium text-center transition-colors duration-200">
                                Back to Cart
                            </a>
                            <button 
                                type="submit" 
                                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-md font-medium transition-colors duration-200"
                            >
                                Place Order
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Order Summary -->
                <div class="lg:col-span-1">
                    <div class="bg-gray-50 p-6 rounded-lg sticky top-6">
                        <h2 class="text-xl font-semibold text-gray-900 mb-6">Order Summary</h2>
                        
                        <!-- Items -->
                        <div class="space-y-4 mb-6">
                            <?php foreach ($cartItems as $item): ?>
                                <div class="flex items-center">
                                    <img 
                                        src="/ampmkp/assets/images/<?php echo $item['product']['image']; ?>" 
                                        alt="<?php echo htmlspecialchars($item['product']['name']); ?>"
                                        class="w-12 h-12 object-cover rounded border border-gray-200"
                                        onerror="this.src='/ampmkp/assets/images/general/placeholder.jpg'"
                                    >
                                    <div class="ml-3 flex-1">
                                        <h4 class="text-sm font-medium text-gray-900">
                                            <?php echo htmlspecialchars($item['product']['name']); ?>
                                        </h4>
                                        <p class="text-sm text-gray-600">
                                            Qty: <?php echo $item['quantity']; ?> Ã— <?php echo formatPrice($item['product']['price']); ?>
                                        </p>
                                    </div>
                                    <div class="text-sm font-semibold text-gray-900">
                                        <?php echo formatPrice($item['item_total']); ?>
                                    </div>
                                </div>
                            <?php endforeach; ?>
                        </div>
                        
                        <!-- Totals -->
                        <div class="border-t border-gray-200 pt-4 space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Subtotal</span>
                                <span class="text-gray-900"><?php echo formatPrice($subtotal); ?></span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Shipping</span>
                                <span class="text-gray-900">
                                    <?php if ($shippingCost > 0): ?>
                                        <?php echo formatPrice($shippingCost); ?>
                                    <?php else: ?>
                                        <span class="text-green-600">Free</span>
                                    <?php endif; ?>
                                </span>
                            </div>
                            <?php if ($subtotal < $settings['shipping']['free_shipping_threshold']): ?>
                                <div class="text-xs text-blue-600">
                                    Add <?php echo formatPrice($settings['shipping']['free_shipping_threshold'] - $subtotal); ?> more for free shipping
                                </div>
                            <?php endif; ?>
                            <div class="border-t border-gray-200 pt-2">
                                <div class="flex justify-between text-lg font-semibold">
                                    <span class="text-gray-900">Total</span>
                                    <span class="text-gray-900"><?php echo formatPrice($total); ?></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Security Notice -->
                        <div class="mt-6 p-4 bg-green-50 border border-green-200 rounded-lg">
                            <div class="flex">
                                <svg class="w-5 h-5 text-green-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                </svg>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-green-800">Secure Checkout</h3>
                                    <p class="mt-1 text-xs text-green-700">Your payment information is secure and encrypted.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.payment-option {
    transition: all 0.2s;
}

input[type="radio"]:checked + .payment-option {
    background-color: #eff6ff;
}

input[type="radio"]:checked + .payment-option .flex {
    border-left: 4px solid #2563eb;
    padding-left: 12px;
}

.payment-form {
    transition: all 0.3s ease-in-out;
    opacity: 0;
    max-height: 0;
    overflow: hidden;
}

.payment-form.active {
    opacity: 1;
    max-height: 1000px;
}

.payment-form.hidden {
    display: none;
}
</style>

<script>
// Payment form management
function showPaymentForm(paymentMethod) {
    // Hide all payment forms
    const forms = document.querySelectorAll('.payment-form');
    forms.forEach(form => {
        form.classList.remove('active');
        form.classList.add('hidden');
    });
    
    // Show selected payment form
    const selectedForm = document.getElementById(paymentMethod + '-form');
    if (selectedForm) {
        selectedForm.classList.remove('hidden');
        setTimeout(() => {
            selectedForm.classList.add('active');
        }, 10);
    }
    
    // Update form validation requirements
    updateFormValidation(paymentMethod);
}

// Update form validation based on payment method
function updateFormValidation(paymentMethod) {
    // Remove required attribute from all payment fields
    const allPaymentInputs = document.querySelectorAll('.payment-form input');
    allPaymentInputs.forEach(input => {
        input.removeAttribute('required');
    });
    
    // Add required attribute to active payment form fields
    if (paymentMethod === 'card') {
        const cardInputs = ['card_number', 'expiry_date', 'cvv', 'cardholder_name'];
        cardInputs.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.setAttribute('required', '');
            }
        });
    }
}

// Card number formatting
function formatCardNumber(input) {
    let value = input.value.replace(/\s/g, '').replace(/[^0-9]/gi, '');
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    if (formattedValue !== input.value) {
        input.value = formattedValue;
    }
    
    // Detect card type and show icon
    detectCardType(value);
}

// Expiry date formatting
function formatExpiryDate(input) {
    let value = input.value.replace(/\D/g, '');
    if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2, 4);
    }
    input.value = value;
}

// Detect card type
function detectCardType(number) {
    const cardTypes = {
        visa: /^4/,
        mastercard: /^5[1-5]/,
        amex: /^3[47]/,
        discover: /^6(?:011|5)/
    };
    
    // This would typically update UI to show card type icon
    for (const [type, pattern] of Object.entries(cardTypes)) {
        if (pattern.test(number)) {
            console.log('Card type detected:', type);
            break;
        }
    }
}

// Form submission validation
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
    
    // Initialize with first checked payment method
    paymentRadios.forEach(radio => {
        if (radio.checked) {
            showPaymentForm(radio.value);
        }
    });
    
    // Form validation on submit
    if (form) {
        form.addEventListener('submit', function(e) {
            const selectedPaymentMethod = document.querySelector('input[name="payment_method"]:checked');
            
            if (!selectedPaymentMethod) {
                e.preventDefault();
                alert('Please select a payment method.');
                return false;
            }
            
            // Validate card details if card payment is selected
            if (selectedPaymentMethod.value === 'card') {
                const cardNumber = document.getElementById('card_number').value.replace(/\s/g, '');
                const expiryDate = document.getElementById('expiry_date').value;
                const cvv = document.getElementById('cvv').value;
                const cardholderName = document.getElementById('cardholder_name').value;
                
                if (!cardNumber || cardNumber.length < 13) {
                    e.preventDefault();
                    alert('Please enter a valid card number.');
                    return false;
                }
                
                if (!expiryDate || expiryDate.length !== 5) {
                    e.preventDefault();
                    alert('Please enter a valid expiry date (MM/YY).');
                    return false;
                }
                
                if (!cvv || cvv.length < 3) {
                    e.preventDefault();
                    alert('Please enter a valid CVV.');
                    return false;
                }
                
                if (!cardholderName.trim()) {
                    e.preventDefault();
                    alert('Please enter the cardholder name.');
                    return false;
                }
                
                // Basic expiry date validation
                const [month, year] = expiryDate.split('/');
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear() % 100;
                const currentMonth = currentDate.getMonth() + 1;
                
                if (parseInt(month) < 1 || parseInt(month) > 12) {
                    e.preventDefault();
                    alert('Please enter a valid month (01-12).');
                    return false;
                }
                
                if (parseInt(year) < currentYear || (parseInt(year) === currentYear && parseInt(month) < currentMonth)) {
                    e.preventDefault();
                    alert('Your card appears to be expired.');
                    return false;
                }
            }
            
            // Show loading state
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.textContent = 'Processing...';
                submitButton.disabled = true;
            }
        });
    }
});
</script>

<?php include 'includes/footer.php'; ?>